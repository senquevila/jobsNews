var cheerio = require('cheerio')
  , download = require('download.js')
  , url = "http://www.empleos.hn/index.php?cat=90"
  , localhost = "http://www.empleos.hn/"
  , element = "table#joblist tr";

module.exports = function (limit, buff, res) {
  var json_array = new Array();
  var iterador = 0;

  for (var i = 0; i < limit; i++) {
    var offset = i * 10;
    var p_url = url + '&offset=' + offset;

    download(p_url, function(data) {
      if (data) {
        var $ = cheerio.load(data.toString('utf-8'));

        $(element).each(function(i, e) {
          var datos = {};
          datos.descripcion = '';

          $(e).find('span').each(function(i, e0){
            datos.descripcion += $(e0).html().trim();
          });

          $(e.children).each(function(j, e1){
            var childrenStr = $(e1.children).text().trim();

            if (j == 1)
              datos.fecha = childrenStr;
            else if (j == 5)
              datos.lugar = childrenStr;

            /*else if (i > 0 && j == 1) {
              var hoy = new Date();
              var fecha = new Date(childrenStr);
              diff = (hoy - fecha) / 1000 / 3600 / 24;
              if (diff > 1000) {
              bShow = false;
              } else {
              bShow = true;
              find = i;
              } 
            }*/
          
          });

        console.log(datos);
        res.write(JSON.stringify(datos));
        });
      }
      else 
        console.error("error");  
    });
  }

  console.log("JSON:\n" + json_array.length);
  res.write(JSON.stringify(json_array));
}