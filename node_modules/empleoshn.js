var cheerio = require('cheerio')
  , request = require('request')
  , url = "http://www.empleos.hn/index.php?cat=90"
  , localhost = "http://www.empleos.hn/"
  , element = "table#joblist tr";
  
String.prototype.replaceAll = function(search, replacement) {
  var target = this;
  return target.replace(new RegExp(search, 'g'), replacement);
};  

function cleanString(cadena) {
  var TempStr = cadena;
  TempStr = TempStr.replaceAll('\r\n', '');
  TempStr = TempStr.replaceAll('\t', '');
  
  return TempStr;
}

function LimiteFecha(fecha, limite) {
  var dhoy = new Date();
  var dfecha = new Date(fecha);
  var diff = (dhoy - dfecha) / 1000 / 86400;
  
  return (diff <= limite);
}

module.exports = function (limit, buff, res) {
  var json_array = new Array();
  var iterador = 0;

  for (var i = 0; i < limit; i++) {
    var offset = i * 10;
    var p_url = url + '&offset=' + offset;

    request(p_url, function(error, respose, body){
      var $ = cheerio.load(body, {
        normalizeWhitespace: true,
        lowerCaseTags: true,
        decodeEntities: true,
        xmlMode: true,
        lowerCaseAttributeNames: true
      });

      $(element).each(function(i, e) {
        var datos = {};
        datos.descripcion = '';

        $(e).find('span').each(function(i, e0){
          datos.descripcion += $(e0).html().trim();            
        });
        
        datos.descripcion = cleanString(datos.descripcion);
        datos.descripcion = datos.descripcion.replaceAll('href=\"/', 'href=\"' + localhost);

        $(e.children).each(function(j, e1){
          var childrenStr = $(e1.children).text().trim();

          if (j == 1)
            datos.fecha = childrenStr;
          else if (j == 5)
            datos.lugar = childrenStr;          
        });
      
       // if (LimiteFecha(datos.fecha, 15))  
       console.log(datos);    
          res.write(JSON.stringify(datos));
      });
    });
  }
}